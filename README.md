# Bitmex Integration Service
## Design choices
The design choices that I have made for this application are described in the document DESING_CHOICES.md which is in the same folder as this README.

## Starting the service
We suggest below two ways to start the service: 
1. Starting the service directly
2. Building a docker image and running the service through docker.

This is a java based service, so it is required to have `java 11` installed locally. However, we leverage a maven wrapper, so there is no need to have maven installed locally.
We also assume that the operating system used to test this code is linux based (Ubuntu for e.g).

### Starting the service directly
This is the fastest way to get the service up and running, below are the steps are to follow:
1. Clone this repository to your local machine with `git clone git@github.com:kapokmi/copper.git` 
2. From the terminal, go to the root folder of the project (the one containing the pom.xml file as a direct child)
3. From that root folder, run the command: `./mvnw spring-boot:run`
4. It takes about 2s for the full application context to be loaded and all the beans wire correctly and after that the service should be up and accessible at `http://localhost:8080/`

### Building a docker image and running it
Here we leverage spring-boot build-image plug-in to build a docker image.
1. Clone this repository to your local machine with `git clone git@github.com:kapokmi/copper.git`
2. From the terminal, go to the root folder of the project (the one containing the pom.xml file as a direct child)
3. From that root folder, run the following command to build a docker image: `./mvnw org.springframework.boot:spring-boot-maven-plugin:2.6.2:build-image -DskipTests=true -Dspring-boot.build-image.imageName=bitmex-integration` (you might need to add `sudo` at the beginning of your command if you don't have a local docker group set up on your machine or if you don't belong to that group.)
4. Once the image has been successfully built, you can run it with the command: `docker run -p 8080:8080 -t bitmex-integration`
5. It takes about 2s for the full application context to be loaded and all the beans wire correctly and after that the service should be up and accessible at `http://localhost:8080/`


## Sample curl requests
All the requests below require to pass, either as parameters or as part of the body, both the `apiKey` and the  `apiSecret` provided by the Bitmex Tesnet. This design choice is explained in the file `DESIGN_CHOICES.md`.
The curl requests provided below also assume they will be run from the same machine where the service is being run.

### Getting balances and reserves for all currencies:
`curl "http://localhost:8080/bitmex/wallets?apiKey=<your-api-key>&apiSecret=<your-api-secret>"`

### Accessing the wallets persisted in the db.
The data is persisted in h2 in memory-db, which can be accessed when the application is up, via the url:
`http://localhost:8080/h2-console/`. The username is `sa` and the password `password`.

### Getting wallet history for a specific currency:
`curl "http://localhost:8080/bitmex/walletHistory?currency=<currency>&count=<count>&startingPoint=<startingPoint>&apiKey=<your-api-key>&apiSecret=<your-api-secret>"`

In the request above, `<currency>`, `<count>` and `<startingPoint>` have to be replaced by specific values keeping the following constraints in mind:
1. currency can have only one of three values `XBt`, `USDt`, `all`.
2. count must be between `0` and `500` both included. The choice of `500` as an upper boundary value was somewhat arbitrary. The rationale is that we wanted to avoid the risk of getting too many transactions from testnet and 500 seemed like a good value.
3. startingPoint must be positive.

### Requesting a withdrawal
```
curl \
    "http://localhost:8080/bitmex/requestWithdrawal" \
    --header "Content-Type: application/json" \
    --data '{
              "apiKey":"<apiKey>",
              "apiSecret":"<apiSecret>",
              "currency": "<currency>",
              "amount": <amount>,
              "address": "<address>",
              "otpToken": <otpToken>
              "text":"<text>",
              "fee":<fee>
            }'
```

In the request above, `<apiKey>`, `<apiSecret>`, `<currency>`, `<amount>`, `<address>`, `<otpToken>`, `<text>` and <fee> have to be replaced by specific values, with the following constraints:
1. `apiKey`, `apiSecret`, `currency`, `amount`, `address` and `otpToken` must always be provided.
2. `address` represents the address of the external exchange/wallet where we want to withdraw the assets to.
3. It is necessary, in order to be able to request a withdrawal, to have a 2-factor authentication set up. This is done through a TOTP app and `otpToken` is the token which will be generated by one such app. You should be careful with the fact the token should still have more than 20s of validity time left when the request is launched.
4. `fee` is optional.
5. `text` is optional and represent a comment that one wants to associate with the withdrawal.
