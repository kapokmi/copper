# Bitmex Integration Service
## Design choices
The design choices that I have made for this application are described in the document DESING_CHOICES.md which is in the same folder as this README.

## Starting the service
To start the service, follow the steps provided below (this is a java based service and we assume below that you have `java 11` at least and `maven` installed on your machine):
1. Clone this repository to your local machine with `git clone git@github.com:kapokmi/copper.git` 
2. From the terminal, go to the root folder of the project (the one containing the pom.xml file as a direct child)
3. From that root folder, run the command: `mvn spring-boot:run`
4. It takes about 2s for the full application context to be loaded and all the beans wire correctly and after that the service should be up.

## Sample curl requests
All the requests below require to pass, either as parameters or as part of the body, both the `apiKey` and the  `apiSecret` provided by the Bitmex Tesnet. This design choice is explained in the file `DESIGN_CHOICES.md`.
The curl requests provided below also assume they will be run from the same machine where the service is being run.

### Getting balances and reserves for all currencies:
`curl "http://localhost:8080/bitmex/wallets?apiKey=<your-api-key>&apiSecret=<your-api-secret>"`

### Accessing the wallets persisted in the db.
The data is persisted in h2 in memory-db, which can be accessed when the application is up, via the url:
`http://localhost:8080/h2-console/`. The username is `sa` and the password `password`.

### Getting wallet history for a specific currency:
`curl "http://localhost:8080/bitmex/walletHistory?currency=<currency>&count=<count>&startingPoint=<startingPoint>&apiKey=<your-api-key>&apiSecret=<your-api-secret>"`

In the request above, `<currency>`, `<count>` and `<startingPoint>` have to be replaced by specific values keeping the following constraints in mind:
1. currency can have only one of three values `XBt`, `USDt`, `all`.
2. count must be between `0` and `500` both included. The choice of `500` as an upper boundary value was somewhat arbitrary. The rationale is that we wanted to avoid the risk of getting too many transactions from testnet and 500 seemed like a good value.
3. startingPoint must be positive.

### Requesting a withdrawal
```
curl \
    "http://localhost:8080/bitmex/requestWithdrawal" \
    --header "Content-Type: application/json" \
    --data '{
              "apiKey":"<apiKey>",
              "apiSecret":"<apiSecret>",
              "currency": "<currency>",
              "amount": <amount>,
              "address": "<address>",
              "otpToken": <otpToken>
              "text":"<text>",
              "fee":<fee>
            }'
```

In the request above, `<apiKey>`, `<apiSecret>`, `<currency>`, `<amount>`, `<address>`, `<otpToken>`, `<text>` and <fee> have to be replaced by specific values, with the following constraints:
1. `apiKey`, `apiSecret`, `currency`, `amount`, `address` and `otpToken` must always be provided.
2. `address` represents the address of the external exchange/wallet where we want to withdraw the assets to.
3. It is necessary, in order to be able to request a withdrawal, to have a 2-factor authentication set up. This is done through a TOTP app and `otpToken` is the token which will be generated by one such app. You should be careful with the fact the token should still have more than 20s of validity time left when the request is launched.
4. `fee` is optional.
5. `text` is optional and represent a comment that one wants to associate with the withdrawal.
